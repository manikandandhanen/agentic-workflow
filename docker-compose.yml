services:
  tools-server:
    build:
      context: ./platform/tools-server
      dockerfile: docker/Dockerfile
      args:
        - USERNAME=qgpadmin
        - USER_UID=1001
        - USER_GID=1001
    container_name: core-tools-server
    env_file:
      - ./platform/tools-server/.env
    ports:
      - "8088:8005"
    volumes:
      - static-files:/app/static
      - ./platform/tools-server/media:/app/media
      - ./platform/tools-server/logs:/app/logs
      - app-schemas:/app/schemas
    entrypoint: ["/bin/sh", "-c", "chown -R 1001:1001 /app/static && exec docker/start.sh server"]
    depends_on:
      - db
      - redis
    restart: unless-stopped
    networks:
      - miq_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8005/healthz/ || exit 1"]
      interval: 30s
      timeout: 60s
      retries: 5

  db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: miq
      POSTGRES_PASSWORD: miqpassword
      POSTGRES_DB: miqdb
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    restart: unless-stopped
    networks:
      - miq_network

  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - redisdata:/data
    restart: unless-stopped
    networks:
      - miq_network

  n8n:
    build:
      context: ./n8n
      dockerfile: docker/images/n8n-dev/Dockerfile
    container_name: n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin@example.com}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-admin}
      - N8N_FEATURE_FLAG_CREDENTIAL_SHARING=true
      - N8N_HOST=n8n
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      # IMPORTANT: external URL seen by browser (through nginx)
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-http://localhost:8090/}
      - N8N_API_BASE_URL=${N8N_API_BASE_URL:-http://localhost:8090/}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_DEFAULT_WORKFLOW_ACTIVE=true
      - N8N_DEFAULT_WORKFLOW=${N8N_DEFAULT_WORKFLOW:-1}
      - N8N_AUTHENTICATION=email
      - N8N_SSO_SECRET=dev-n8n-sso-secret
      - N8N_DISABLE_UI_SECURITY=true
      - N8N_XFRAME_BYPASS=true
    # no host port, only internal
    # ports:
    #   - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - tools-server
    networks:
      - miq_network

  nginx:
    image: nginx:alpine
    container_name: nginx
    depends_on:
      - n8n
    ports:
      - "8090:80"          # <- only this is exposed to host
    networks:
      - miq_network
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

volumes:
  pgdata:
  redisdata:
  app-schemas:
  static-files:
  n8n_data:

networks:
  miq_network:
    driver: bridge
