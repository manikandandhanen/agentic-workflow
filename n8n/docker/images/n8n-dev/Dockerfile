# docker/images/n8n-dev/Dockerfile

ARG NODE_VERSION=22.21.0
ARG N8N_VERSION=snapshot
ARG LAUNCHER_VERSION=1.4.0
ARG TARGETPLATFORM

# ==============================================================================
# STAGE 1: System dependencies (Node + tools)
# ==============================================================================
FROM n8nio/base:${NODE_VERSION} AS system-deps

USER root
WORKDIR /home/node

# ðŸ” Corporate CA
COPY docker/images/n8n-dev/certs/company-ca.crt \
     /usr/local/share/ca-certificates/company-ca.crt
RUN update-ca-certificates

# ðŸŒ Make Node / HTTP libraries trust the corporate CA
ENV SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt \
    REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt \
    NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/company-ca.crt

# ==============================================================================
# STAGE 2: Application artifact processor
# - Uses *your* compiled local code (./compiled)
#   generated by `pnpm build:docker`
# ==============================================================================
FROM alpine:3.22.0 AS app-artifact-processor
WORKDIR /app


# ðŸ‘‡ THIS FOLDER MUST EXIST (created by `pnpm build:docker`)
COPY ./compiled /app/

# ==============================================================================
# STAGE 3: Task Runner Launcher download (same as upstream)
# ==============================================================================
FROM alpine:3.22.0 AS launcher-downloader
ARG TARGETPLATFORM
ARG LAUNCHER_VERSION

RUN set -e; \
    case "$TARGETPLATFORM" in \
        "linux/amd64") ARCH_NAME="amd64" ;; \
        "linux/arm64") ARCH_NAME="arm64" ;; \
        *) echo "Unsupported platform: $TARGETPLATFORM" && exit 1 ;; \
    esac; \
    mkdir /launcher-temp && cd /launcher-temp; \
    wget -q "https://github.com/n8n-io/task-runner-launcher/releases/download/${LAUNCHER_VERSION}/task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz"; \
    wget -q "https://github.com/n8n-io/task-runner-launcher/releases/download/${LAUNCHER_VERSION}/task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz.sha256"; \
    echo "$(cat task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz.sha256) task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz" > checksum.sha256; \
    sha256sum -c checksum.sha256; \
    mkdir -p /launcher-bin; \
    tar xzf task-runner-launcher-${LAUNCHER_VERSION}-linux-${ARCH_NAME}.tar.gz -C /launcher-bin; \
    cd / && rm -rf /launcher-temp

# ==============================================================================
# STAGE 4: Final runtime image (uses system-deps + your compiled code)
# ==============================================================================
FROM system-deps AS runtime

ARG N8N_VERSION
ARG N8N_RELEASE_TYPE=dev

ENV NODE_ENV=production \
    N8N_RELEASE_TYPE=${N8N_RELEASE_TYPE} \
    NODE_ICU_DATA=/usr/local/lib/node_modules/full-icu \
    SHELL=/bin/sh

WORKDIR /home/node

# Bring in your compiled n8n bundle
COPY --from=app-artifact-processor /app /usr/local/lib/node_modules/n8n

# Bring in launcher binary
COPY --from=launcher-downloader /launcher-bin/* /usr/local/bin/

# Entry script + task-runner config from your repo
COPY docker/images/n8n/docker-entrypoint.sh /
COPY docker/images/n8n/n8n-task-runners.json /etc/n8n-task-runners.json

# Rebuild sqlite3, create symlink, and fix permissions
RUN cd /usr/local/lib/node_modules/n8n && \
    npm rebuild sqlite3 && \
    ln -s /usr/local/lib/node_modules/n8n/bin/n8n /usr/local/bin/n8n && \
    mkdir -p /home/node/.n8n && \
    chown -R node:node /home/node

# pdfjs canvas dependency (matches upstream)
RUN cd /usr/local/lib/node_modules/n8n/node_modules/pdfjs-dist && \
    npm install @napi-rs/canvas

EXPOSE 5678/tcp

USER node

ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]
